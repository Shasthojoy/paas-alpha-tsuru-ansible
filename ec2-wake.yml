---
  - hosts: localhost
    tasks:
      - name: Copy ec2.py to /tmp
        copy: src="./ec2.py" dest="/tmp/ec2.py" mode=0744
      - name: Copy ec2.ini to /tmp
        copy: src="./ec2.ini" dest="/tmp/ec2.ini" mode=0644
      - name: Get stopped instances
        shell: "./ec2.py --stopped --refresh-cache"
        args:
          chdir: /tmp
        register: ec2_hosts_raw
      - set_fact:
          ec2_hosts: "{{ ec2_hosts_raw.stdout|from_json }}"
      - name: Wake instances
        ec2:
          region: "eu-west-1"
          state: 'running'
          instance_ids: "{{ item.value.ec2_id }}"
        when: item.value.ec2_tag_Name is defined and item.value.ec2_tag_Name | match("^{{ deploy_env }}-*")
        with_dict: ec2_hosts._meta.hostvars
