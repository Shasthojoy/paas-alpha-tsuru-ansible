- hosts: "{{ hosts_prefix }}-influx-grafana*"
  sudo: yes
  vars:
    influxdb_version: latest
  tasks: # The influxdb and telegraf packages disagree on ownership of /var/run/influxdb - Telegraf Issue #37
    - name: Create /etc/default/telegraf to fix conflict between influxdb and telegraf packages
      copy: dest=/etc/default/telegraf mode=0644 content="USER=influxdb\nGROUP=influxdb\n"
  roles:
    - role: influxdb
    - role: telegraf
    - role: Stouts.grafana
  post_tasks:
    - name: Copy grafana API control script
      copy: src=datasource.sh dest=/usr/local/bin/datasource.sh mode=0750 owner=root group=root
    - name: Add influx datasource to grafana
      shell: /usr/local/bin/datasource.sh {{ influxdb_database }}

- hosts: "{{ hosts_prefix }}-*"
  sudo: yes
  roles:
    - telegraf
